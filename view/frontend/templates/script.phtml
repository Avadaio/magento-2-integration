<?php
/**
 * Mageplaza
 *
 * NOTICE OF LICENSE
 *
 * This source file is subject to the Mageplaza.com license that is
 * available through the world-wide-web at this URL:
 * https://www.mageplaza.com/LICENSE.txt
 *
 * DISCLAIMER
 *
 * Do not edit or add to this file if you wish to upgrade this extension to newer
 * version in the future.
 *
 * @category    Mageplaza
 * @package     Mageplaza_Smtp
 * @copyright   Copyright (c) Mageplaza (https://www.mageplaza.com/)
 * @license     https://www.mageplaza.com/LICENSE.txt
 */

/**
 * @var \Mageplaza\Smtp\Block\Script $block
 */

$shopId = $block->getHelperAbandonedCart()->getAppID();
$isSuccessPage = $block->isSuccessPage();
?>
<!-- BEGIN MAGEPLAZA SMTP SCRIPT-->
<?php if ($isSuccessPage && $block->getCurrentOrder()) {
    $order        = $block->getCurrentOrder();
    $grandTotal   = $order->getGrandTotal();
    $currencyCode = $order->getOrderCurrencyCode();
    $checkoutId   = $order->getQuoteId();
    $email        = $order->getCustomerEmail();

    ?>
    <script data-cfasync="false" type="text/javascript">var AVADA_EM={vendor:"magento",checkout:{revenue:"<?=  /* @noEscape */ $grandTotal ?>",currency:"<?=  /* @noEscape */ $currencyCode ?>",checkoutId:"<?=  /* @noEscape */ $checkoutId ?>",checkoutEmail:"<?=  /* @noEscape */ $email ?>"}};</script>
<?php } else { ?>

    <script data-cfasync="false" type="text/javascript">const date=new Date,params=new URL(document.location).searchParams;"true"===params.get("isEmCheckout")&&params.get("token")&&(localStorage.getItem("avada-em-converted")&&localStorage.removeItem("avada-em-converted"),localStorage.setItem("avada-em-converted",JSON.stringify({token:params.get("token"),expiredAt:date.setHours(date.getHours()+72)})),params.get("redirectUrl")&&window.location.replace(params.get("redirectUrl")));const sdk=document.createElement("script");sdk.type="text/javascript",sdk.async=!0,sdk.src="https://app.avada.io/scripttag/avada-email-marketing.min.js?shopId=<?=  /* @noEscape */ $shopId ?>";const currentScript=document.getElementsByTagName("script")[0];currentScript.parentNode.insertBefore(sdk,currentScript);</script>

<?php } ?>
<!-- END MAGEPLAZA SMTP SCRIPT-->
